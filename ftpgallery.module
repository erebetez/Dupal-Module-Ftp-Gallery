<?php

/**
 * Implementation of hook_help().
 */
function ftpgallery_help($path, $arg) {
  switch ($path) {
    case 'admin/help#ftpgallery':
      $output = '<p>' . t("Hello Help.") . '</p>';
 
      return $output;
  }
}


/**
* Valid permissions for this module
* @return array An array of valid permissions for the ftpgallery module
*/
function ftpgallery_perm() {
  return array('access ftp gallery content');
}


/**
* Implementation of hook_block().
* @param string $op one of "list", "view", "save" and "configure"
* @param integer $delta code to identify the block
* @param array $edit only for "save" operation
*/
function ftpgallery_block($op = 'list', $delta = 0, $edit = array()) { 

  if ($op == "list") {
    // Generate listing of blocks from this module, for the admin/block page
    $block[0]["info"] = t('FTP Gallery');
  }
  else if ($op == 'view') {

    // Generate our block content

    // content variable that will be returned for display
    $block_content = '';

    // Get today's date
    $today = getdate();

    // calculate midnight one week ago
    $start_time = mktime(0, 0, 0,$today['mon'],
                               ($today['mday'] - 7), $today['year']);

    // we want items that occur only on the day in question, so
    //calculate 1 day
    $end_time = $start_time + 86400;
    // 60 * 60 * 24 = 86400 seconds in a day

    $limitnum = variable_get("ftpgallery_maxdisp", 3);

    $query = "SELECT nid, title, created FROM " .
           "{node} WHERE created >= %d " .
           "AND created <= %d";

    $query_result = db_query_range($query, $start_time, $end_time, 0, $limitnum);

    while ($links = db_fetch_object($query_result)) {
      $block_content .= l($links->title, 'node/'.$links->nid) . '<br />';
    }

    // Fill in the subject of our block which is the same whether or not
    // the block has any real content
    $block['subject'] = 'Gallery Block';

    // check to see if there was any content before returning
    //  the block view
    if ($block_content == '') {  
       // no content from a week ago
       $block['content'] = 'Sorry No Content';
    }
    else {
      // set up the block
      $block['content'] = $block_content;
    }
  }

  return $block;
} // function ftpgallery_block


function ftpgallery_admin() {
  $form = array();

  $form['ftpgallery_maxdisp'] = array(
    '#type' => 'textfield',
    '#title' => t('Maximum number of links'),
    '#default_value' => variable_get('ftpgallery_maxdisp', 3),
    '#size' => 2,
    '#maxlength' => 2,
    '#description' => t("The maximum number of links to display in the block."),
    '#required' => TRUE,
  );

  return system_settings_form($form);
}

function ftpgallery_admin_validate($form, &$form_state) {
  $maxdisp = $form_state['values']['ftpgallery_maxdisp'];
  if (!is_numeric($maxdisp)) {
    form_set_error('ftpgallery_maxdisp', t('You must enter an integer for the maximum number of links.'));
  }
  else if ($maxdisp <= 0) {
    form_set_error('ftpgallery_maxdisp', t('Maximum number of links must be positive.'));
  }
}

function ftpgallery_menu() {

  $items = array();

  $items['admin/settings/ftpgallery'] = array(
    'title' => t('FTP Gallery module settings'),
    'description' => t('FTP Gallery settings page'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ftpgallery_admin'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
   );

  return $items;
}
